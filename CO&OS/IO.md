## 程序中断
I/O控制方式之一
程序中断即采用中断的方式使CPU去处理外设  
外设主动发送中断请求，请求CPU调用ISR来服务外设

* I/O程序中断的中断源是CPU外部硬件设备，故属于外部中断
* 外部中断分可屏蔽中断与不可屏蔽中断


## 硬件
### INTR与NMI
CPU的两个引脚。

INTR对应可屏蔽中断。连接IC与CPU。INTR传递中断控制器依据优先级和屏蔽位判断后传递的中断信号，CPU检查IF标志位，决定是否响应中断信号。

NMI对应不可屏蔽中断。不连接中断控制器，直接连接外设与CPU，且不需要IF标志位

```markdown
普通中断路径（可屏蔽）：
设备 ─► 中断控制器(IC) ─► INTR ─► CPU
                      ↑
                     (可屏蔽，受IF控制)

不可屏蔽中断路径：
设备 ─────────────────► NMI ─► CPU
                          ↑
                       (不可屏蔽)
```

### 中断控制器IC
中断控制器作为中断方式的重要部分，其连接外设与CPU（通过INTR连接CPU）

其功能：
* 接收和保存由IRQ传来的的外设的中断请求
* 负责响应优先级仲裁，选出最高级响应优先级中断请求传达至CPU，不参与处理优先级比较
* 屏蔽指定中断源，使其不参与仲裁

### 屏蔽字寄存器&屏蔽字触发器
I/O接口为每个中断源（发出中断请求的外设）都有设置一个屏蔽字触发器（），所有的屏蔽字触发器组成屏蔽字寄存器（寄存器，一组触发器组成的集合）

### 中断请求硬件路径
由外设（中断源）发出中断请求，经过IRQ传到IC，IC处理后交给CPU

---

## 机制名词
### 中断识别 & 中断向量
不同的中断源分配不同的IRQ，每个IRQ都有中断

中断向量表存于内存中，记录不同中断类型的ISR的


### 中断屏蔽技术&屏蔽字
中断屏蔽技术在响应优先级仲裁之前生效，用于屏蔽部分中断源，使被屏蔽的中断无法参与响应优先级的比较过程。

是一种由硬件或软件控制的机制，用于临时禁止某些中断源参与仲裁或响应。其核心目的是防止低优先级中断干扰高优先级任务的执行，或在特定阶段禁止中断。（它的作用是限制哪些中断源能进入响应优先级仲裁，属于“权限控制”，不是“优先级排序”）

屏蔽字存放于屏蔽字寄存器。每一位对应一个中断源，表示能否参与响应优先级仲裁。

屏蔽字是用来指示哪些中断源被屏蔽（禁止）或允许。高优先级的请求设置屏蔽字屏蔽相对低优先级的请求，从而使自身优先被处理（让CPU“暂时看不到”其他请求，CPU优先处理没有被设置屏蔽字的中断请求）



### 单重中断&多重中断
在CPU为一个中断请求执行对应的ISR时，出现其他的中断请求，根据CPU的不同反应分为单重中断和多重中断。

注意，这里对于新的中断请求的不同响应都是针对可屏蔽中断。

不可屏蔽中断独立于单重中断与多重中断的分类。

#### 单重中断
CPU只专注于当前ISR，不响应新的中断请求，不允许当前ISR被打断。

#### 多重中断 & 中断嵌套 & 抢占ISR
中断嵌套即为多重中断。

CPU依据优先级的高低，如果新的中断请求的优先级更高，则会中止（不是终止）当前ISR，转而处理新的中断请求，为新的中断请求调用ISR。

多重中断首先要在ISR中设置开中断，同时要具备处理优先级（允许中断请求去中断低优先级中断请求，）

多重中断使中断处理并发（不是并行），

### 中断优先级

中断优先级分响应优先级和处理优先级

#### 响应优先级
由中断控制器的硬件仲裁机制决定，与中断请求到达的先后次序无关。

当多个中断请求同时或接近同时到达时，中断控制器会根据各中断源的响应优先级字段（或固定优先级顺序）进行比较，选出优先级最高的请求送往 CPU。

这种优先级仲裁完全由硬件逻辑自动完成，而不是根据信号的到达时间来排序。

#### 处理优先级
处理中断的优先级由CPU完全控制，CPU的软件或硬件可动态调整处理优先级寄存器的值，以实现嵌套中断或优先级屏蔽。

IC只负责传递优先级信息而不参与CPU内部仲裁。

CPU内部维护一个处理优先级寄存器，用于表示当前中断处理层级。该寄存器的值可由CPU或软件修改，以控制是否允许更高优先级的中断打断当前ISR。
##### 处理优先级在多重中断生效
处理优先级机制出现在支持多重中断的系统中，用于判断CPU在执行某个ISR时，是否允许更高优先级的中断打断当前服务。
* 在单重中断系统中，CPU不会响应新的中断，因此只存在响应优先级仲裁；
* 在多重中断系统中，CPU需要依据当前中断层级（处理优先级）决定是否允许中断嵌套。
##### IC与CPU的责任与参与
###### IC发送请求
中断控制器（IC）会根据各中断源的响应优先级信息，选出响应优先级最高的中断请求发送给CPU。  
###### CPU是否接收请求以及处理优先级比较
处理优先级机制的运行前提是IF标志位为1（开中断）。  

当CPU允许接受中断时，会比较该请求的中断优先级与当前CPU内部的处理优先级寄存器（如TPR、BASEPRI）值：  
- 若新中断的优先级高于当前阈值（且IF标志位允许），CPU将中止当前ISR，查找中断向量表，转去执行新的ISR；  
- 若低于或相等，则暂不响应，待当前ISR结束后再处理。
###### CPU接受中断请求
当CPU进入新ISR时，会更新“处理优先级寄存器”为当前ISR的优先级；
当ISR执行结束后，再恢复至上一级优先级值。

### 可屏蔽中断 & 不可屏蔽中断



---

## 中断处理过程
